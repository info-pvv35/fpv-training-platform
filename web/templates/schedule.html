<!DOCTYPE html>
<html lang="ru" hx-ext="sse">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPV –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ ‚Äî –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º HTMX –∏ SSE extension -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/htmx.org/dist/ext/sse.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ FPV-—Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h1>
        <p class="last-updated">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="current-time"></span></p>

        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥–∞–º -->
        <div class="filters">
            <label for="cityFilter">–§–∏–ª—å—Ç—Ä –ø–æ –≥–æ—Ä–æ–¥—É:</label>
            <select id="cityFilter" onchange="filterByCity()">
                <option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>
                {% for city in cities %}
                    <option value="{{ city }}">{{ city }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ–º (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ HTMX) -->
        <div id="schedule-container"
             hx-sse="connect:/updates"
             hx-trigger="sse:refresh"
             hx-get="/schedule-partial"
             hx-swap="innerHTML"
             hx-indicator="#loading-indicator">
            
            <!-- –°—é–¥–∞ –ø–æ–¥—Å—Ç–∞–≤–∏—Ç—Å—è —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ schedule-partial.html -->
            {% include 'partials/schedule_table.html' %}
            
        </div>

        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏ -->
        <div id="loading-indicator" class="htmx-indicator" style="text-align: center; margin: 20px 0; display: none;">
            <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        </div>

        <p class="auto-update">–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥. –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="last-update">—Å–µ–π—á–∞—Å</span></p>

        <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∫—É (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω) -->
        {% if is_admin %}
            <a href="/admin" class="admin-link">üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</a>
        {% endif %}

        <!-- QR-–∫–æ–¥ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ -->
        <div class="qr-section">
            <h3>üì± –û—Ç–∫—Ä–æ–π—Ç–µ –Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–µ</h3>
            <img src="/static/qr-schedule.png" alt="QR-–∫–æ–¥ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è" style="max-width: 200px; border-radius: 10px;">
            <p>–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –∏–ª–∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤ –∑–∞–∫–ª–∞–¥–∫–∏!</p>
        </div>

        <!-- –°—Å—ã–ª–∫–∞ –Ω–∞ –ø–æ–ª–∏—Ç–∏–∫—É –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ -->
        <footer>
            <p>
                <a href="/privacy">üìú –ü–æ–ª–∏—Ç–∏–∫–∞ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏</a> | 
                <a href="https://t.me/–≤–∞—à_–±–æ—Ç" target="_blank">ü§ñ –ù–∞—à Telegram-–±–æ—Ç</a>
            </p>
            <p>¬© {{ year }} FPV Training Platform. –í—Å–µ –ø—Ä–∞–≤–∞ –∑–∞—â–∏—â–µ–Ω—ã.</p>
        </footer>
    </div>

    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .htmx-indicator {
            display: none;
        }
        .htmx-request .htmx-indicator {
            display: inline-block;
        }
    </style>

    <script>
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = now.toLocaleString('ru-RU');
            document.getElementById('last-update').textContent = "—Å–µ–π—á–∞—Å";
        }
        updateTime();
        setInterval(updateTime, 60000);

        // –û–±–Ω–æ–≤–ª—è–µ–º last-update –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ HTMX
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'schedule-container') {
                document.getElementById('last-update').textContent = "—Ç–æ–ª—å–∫–æ —á—Ç–æ";
                setTimeout(() => {
                    document.getElementById('last-update').textContent = "30 —Å–µ–∫ –Ω–∞–∑–∞–¥";
                }, 30000);
            }
        });

        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –≥–æ—Ä–æ–¥–∞–º
        function filterByCity() {
            const city = document.getElementById('cityFilter').value;
            const sections = document.querySelectorAll('.city-section');
            
            sections.forEach(section => {
                if (city === "" || section.querySelector('.city-title').textContent.includes(city)) {
                    section.style.display = 'block';
                    section.style.opacity = '0';
                    setTimeout(() => {
                        section.style.transition = 'opacity 0.5s ease';
                        section.style.opacity = '1';
                    }, 50);
                } else {
                    section.style.display = 'none';
                }
            });
        }

        // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                document.querySelector('.container').style.opacity = '1';
                document.querySelector('.container').style.transform = 'translateY(0)';
            }, 100);
        });
    </script>
</body>
</html>