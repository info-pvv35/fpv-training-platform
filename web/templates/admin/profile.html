{% extends "admin/base.html" %}

{% block title %}üë§ –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å FPV{% endblock %}

{% block page_title %}–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å{% endblock %}

{% block content %}
<div class="profile-container">
    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="profile-section">
        <h2><i class="fas fa-user-circle"></i> –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h2>
        <div class="info-grid">
            <div class="info-item">
                <label>Telegram ID:</label>
                <div class="info-value">{{ current_user.id }}</div>
            </div>
            <div class="info-item">
                <label>–†–æ–ª—å:</label>
                <div class="info-value">
                    <span class="role-badge {{ admin.role }}">
                        {% if admin.role == 'super_admin' %}
                            üëë –°—É–ø–µ—Ä–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                        {% else %}
                            üìç –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–ª–æ—â–∞–¥–æ–∫
                        {% endif %}
                    </span>
                </div>
            </div>
            <div class="info-item">
                <label>Username:</label>
                <div class="info-value">
                    {% if user_data.username %}
                        @{{ user_data.username }}
                    {% else %}
                        <span class="empty-value">–ù–µ —É–∫–∞–∑–∞–Ω</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <label>–ù–∏–∫–Ω–µ–π–º:</label>
                <div class="info-value">
                    {% if user_data.nickname %}
                        {{ user_data.nickname }}
                    {% else %}
                        <span class="empty-value">–ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <label>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:</label>
                <div class="info-value">
                    {% if user_data.consent_date %}
                        {{ user_data.consent_date.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        <span class="empty-value">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                    {% endif %}
                </div>
            </div>
            <div class="info-item">
                <label>–î–∞—Ç–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∞–¥–º–∏–Ω–æ–º:</label>
                <div class="info-value">
                    {% if admin.created_at %}
                        {{ admin.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                        <span class="empty-value">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–∏ –ø–ª–æ—â–∞–¥–∫–∏ (–¥–ª—è location_admin) -->
    {% if admin.role == 'location_admin' and admin.managed_locations %}
        <div class="profile-section">
            <h2><i class="fas fa-map-marked-alt"></i> –ú–æ–∏ –ø–ª–æ—â–∞–¥–∫–∏</h2>
            <div class="locations-grid">
                {% for loc in admin.managed_locations %}
                    <div class="location-card">
                        <div class="location-header">
                            <i class="fas fa-city"></i>
                            <span class="location-city">{{ loc.city }}</span>
                        </div>
                        <div class="location-body">
                            <i class="fas fa-map-pin"></i>
                            <span class="location-name">{{ loc.location }}</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
    <div class="profile-section">
        <h2><i class="fas fa-chart-bar"></i> –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-check"></i>
                </div>
                <div class="stat-info">
                    <h3>–î–æ–±–∞–≤–ª–µ–Ω–æ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫</h3>
                    <div class="stat-value">{{ stats.added_trainings }}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stat-info">
                    <h3>–ó–∞–ø–∏—Å–µ–π –ø–∏–ª–æ—Ç–æ–≤</h3>
                    <div class="stat-value">{{ stats.pilot_registrations }}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-edit"></i>
                </div>
                <div class="stat-info">
                    <h3>–ò–∑–º–µ–Ω–µ–Ω–∏–π –∫–∞–Ω–∞–ª–æ–≤</h3>
                    <div class="stat-value">{{ stats.channel_edits }}</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-info">
                    <h3>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                    <div class="stat-value">
                        {% if stats.last_activity %}
                            {{ stats.last_activity.strftime('%Y-%m-%d %H:%M') }}
                        {% else %}
                            –ù–∏–∫–æ–≥–¥–∞
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å -->
    <div class="profile-section">
        <h2><i class="fas fa-shield-alt"></i> –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</h2>
        <div class="security-section">
            <div class="security-item">
                <h3><i class="fas fa-key"></i> –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h3>
                <p>–î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Telegram. –ü–∞—Ä–æ–ª—å –º–µ–Ω—è–µ—Ç—Å—è —Ä–µ–¥–∫–æ.</p>
                <button class="btn btn-warning" onclick="requestPasswordChange()">
                    <i class="fas fa-exchange-alt"></i> –ó–∞–ø—Ä–æ—Å–∏—Ç—å —Å–º–µ–Ω—É –ø–∞—Ä–æ–ª—è
                </button>
            </div>
            
            <div class="security-item">
                <h3><i class="fas fa-history"></i> –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</h3>
                <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –≤–∞—à–∏—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ —Å–∏—Å—Ç–µ–º–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π.</p>
                <a href="/admin/audit?user={{ current_user.id }}" class="btn btn-info">
                    <i class="fas fa-clipboard-list"></i> –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è
                </a>
            </div>
            
            <div class="security-item">
                <h3><i class="fas fa-sign-out-alt"></i> –í—ã—Ö–æ–¥ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</h3>
                <p>–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ–∫—É—â—É—é —Å–µ—Å—Å–∏—é –∏ –≤—ã–π—Ç–∏ –∏–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.</p>
                <a href="{{ url_for('admin_logout') }}" class="btn btn-danger">
                    <i class="fas fa-sign-out-alt"></i> –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
                </a>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è -->
    <div id="passwordModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closePasswordModal()">&times;</span>
            <h2><i class="fas fa-key"></i> –°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</h2>
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle"></i>
                –î–ª—è —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram. –í–∞–º –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω 2FA-–∫–æ–¥.
            </div>
            <form id="passwordForm">
                <div class="form-group">
                    <label for="current_password">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" name="current_password" id="current_password" required>
                </div>
                <div class="form-group">
                    <label for="new_password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å:</label>
                    <input type="password" name="new_password" id="new_password" required minlength="8">
                    <div class="password-hint">–ú–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤</div>
                </div>
                <div class="form-group">
                    <label for="confirm_password">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è:</label>
                    <input type="password" name="confirm_password" id="confirm_password" required>
                </div>
                <div class="form-group">
                    <label for="2fa_code">2FA –∫–æ–¥ –∏–∑ Telegram:</label>
                    <input type="text" name="2fa_code" id="2fa_code" required pattern="[0-9]{6}" placeholder="6 —Ü–∏—Ñ—Ä">
                    <div class="help-text">
                        <i class="fas fa-info-circle"></i>
                        –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±–æ—Ç—É –∫–æ–º–∞–Ω–¥—É <code>/get_2fa_code</code> –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–¥–∞
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closePasswordModal()">
                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.profile-container {
    padding: 20px;
}

/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */
.info-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.info-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
}

.info-item label {
    display: block;
    color: #95a5a6;
    font-size: 0.9em;
    margin-bottom: 8px;
    font-weight: 500;
}

.info-item .info-value {
    color: white;
    font-size: 1.1em;
    font-weight: 600;
}

.empty-value {
    color: #95a5a6;
    font-style: italic;
}

.role-badge {
    padding: 6px 15px;
    border-radius: 20px;
    font-size: 0.9em;
    font-weight: 600;
    display: inline-block;
}

.role-badge.super_admin {
    background: rgba(231, 76, 60, 0.2);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.3);
}

.role-badge.location_admin {
    background: rgba(52, 152, 219, 0.2);
    color: #3498db;
    border: 1px solid rgba(52, 152, 219, 0.3);
}

/* –ú–æ–∏ –ø–ª–æ—â–∞–¥–∫–∏ */
.locations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.location-card {
    background: rgba(255, 255, 255, 0.05);
    padding: 20px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s ease;
}

.location-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.location-header {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 15px;
    padding-bottom: 15px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
}

.location-header i {
    color: #3498db;
    font-size: 1.3em;
}

.location-city {
    color: white;
    font-size: 1.2em;
    font-weight: 600;
}

.location-body {
    display: flex;
    align-items: center;
    gap: 10px;
}

.location-body i {
    color: #2ecc71;
    font-size: 1.1em;
}

.location-name {
    color: #ecf0f1;
    font-size: 1.1em;
}

/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    padding: 25px;
    border-radius: 15px;
    text-align: center;
    border: 1px solid rgba(255,255,255,0.1);
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
}

.stat-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.stat-icon {
    font-size: 2.5em;
    margin-bottom: 15px;
    color: white;
}

.stat-info h3 {
    color: #ecf0f1;
    margin: 0 0 15px 0;
    font-size: 1em;
    font-weight: 500;
}

.stat-info .stat-value {
    font-size: 2em;
    font-weight: 700;
    color: white;
    line-height: 1;
}

.stat-card:nth-child(1) .stat-icon { color: #3498db; }
.stat-card:nth-child(2) .stat-icon { color: #2ecc71; }
.stat-card:nth-child(3) .stat-icon { color: #f39c12; }
.stat-card:nth-child(4) .stat-icon { color: #9b59b6; }

/* –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å */
.security-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 30px;
    margin-top: 20px;
}

.security-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 25px;
    border-radius: 15px;
    border: 1px solid rgba(255,255,255,0.1);
    backdrop-filter: blur(10px);
}

.security-item h3 {
    color: white;
    margin: 0 0 20px 0;
    font-size: 1.3em;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 10px;
}

.security-item p {
    color: #ecf0f1;
    font-size: 1em;
    margin-bottom: 20px;
    line-height: 1.6;
}

.security-item .btn {
    width: 100%;
    padding: 12px 20px;
    font-size: 1em;
    border-radius: 25px;
    margin-top: 10px;
}

/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.7);
    overflow: auto;
}

.modal-content {
    background: linear-gradient(135deg, #1e3c72, #2a5298);
    margin: 5% auto;
    padding: 30px;
    width: 90%;
    max-width: 500px;
    border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.5);
    position: relative;
    border: 1px solid rgba(255,255,255,0.2);
}

.close {
    color: #aaa;
    float: right;
    font-size: 35px;
    font-weight: bold;
    cursor: pointer;
    position: absolute;
    right: 25px;
    top: 20px;
    transition: color 0.3s;
}

.close:hover {
    color: white;
}

.modal-content h2 {
    color: white;
    text-align: center;
    margin-bottom: 30px;
    font-size: 1.8em;
    font-weight: 600;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
}

.alert {
    padding: 15px;
    margin-bottom: 25px;
    border-radius: 10px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 15px;
    background: rgba(241, 196, 15, 0.2);
    color: #f1c40f;
    border-left: 4px solid #f1c40f;
}

.alert i {
    font-size: 1.5em;
}

.form-group {
    margin-bottom: 25px;
}

.form-group label {
    display: block;
    margin-bottom: 10px;
    color: white;
    font-weight: 500;
    font-size: 1.1em;
}

.form-group input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 8px;
    background: rgba(255, 255, 255, 0.1);
    color: white;
    font-size: 1em;
    transition: all 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #3498db;
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.3);
}

.password-hint {
    color: #95a5a6;
    font-size: 0.9em;
    margin-top: 5px;
}

.help-text {
    color: #95a5a6;
    font-size: 0.9em;
    margin-top: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
}

.help-text code {
    background: rgba(0, 0, 0, 0.3);
    padding: 3px 8px;
    border-radius: 5px;
    font-family: 'Courier New', monospace;
    color: #ecf0f1;
}

.form-actions {
    display: flex;
    gap: 15px;
    justify-content: center;
    margin-top: 30px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .info-grid {
        grid-template-columns: 1fr;
    }
    
    .locations-grid {
        grid-template-columns: 1fr;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .security-section {
        grid-template-columns: 1fr;
    }
    
    .modal-content {
        margin: 10% auto;
        padding: 20px;
        width: 95%;
    }
    
    .form-actions {
        flex-direction: column;
    }
    
    .security-item .btn {
        width: 100%;
    }
}

/* –ê–Ω–∏–º–∞—Ü–∏–∏ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

.profile-container {
    animation: fadeIn 0.5s ease-out;
}

.location-card, .stat-card, .security-item {
    animation: fadeIn 0.3s ease-out;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    function requestPasswordChange() {
        document.getElementById('passwordModal').style.display = 'block';
    }
    
    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
    }
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ
    window.onclick = function(event) {
        const modal = document.getElementById('passwordModal');
        if (event.target == modal) {
            modal.style.display = 'none';
        }
    }
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã —Å–º–µ–Ω—ã –ø–∞—Ä–æ–ª—è
    const passwordForm = document.getElementById('passwordForm');
    if (passwordForm) {
        passwordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData(passwordForm);
            const data = Object.fromEntries(formData);
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (data.new_password !== data.confirm_password) {
                alert('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç!');
                return;
            }
            
            if (data.new_password.length < 8) {
                alert('–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤!');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            fetch('/admin/profile/change-password', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    alert('–ü–∞—Ä–æ–ª—å —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω—ë–Ω!');
                    closePasswordModal();
                    passwordForm.reset();
                } else {
                    alert('–û—à–∏–±–∫–∞: ' + data.message);
                }
            })
            .catch(error => {
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–æ–ª—è');
                console.error('Error:', error);
            });
        });
    }
    
    // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
    setTimeout(() => {
        document.querySelector('.profile-container').style.opacity = '1';
    }, 100);
});
</script>
{% endblock %}